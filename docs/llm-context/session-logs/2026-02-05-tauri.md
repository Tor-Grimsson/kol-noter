# Session Log — 2026-02-05 (Tauri Architecture)

## Session Summary

Implemented Local-First Markdown Architecture for KOL-Noter. Completed Phases 0-2: Tauri foundation, persistence abstraction, and file serialization.

## What Was Done

### 1. Phase 0: Tauri Foundation

**Initialized Tauri v2:**
- Ran `npx @tauri-apps/cli init` to scaffold `src-tauri/`
- Configured `tauri.conf.json` with app metadata, window settings
- Added plugins via `npx tauri add fs` and `npx tauri add dialog`

**Created Tauri Bridge (`src/lib/tauri-bridge.ts`):**
- File system operations: read, write, mkdir, remove, rename, exists
- Dialog operations: folder picker, save dialog, message, confirm
- Path utilities: joinPath, getFilename, getDirname, getExtension
- Vault helpers: initializeVault, isValidVault, getDefaultVaultPath
- Environment detection: `isTauri()` function

### 2. Phase 1: Persistence Abstraction

**Created Interface (`src/lib/persistence/types.ts`):**
```typescript
interface IPersistenceAdapter {
  loadAll(): Promise<VaultData>;
  saveNote(note: Note): Promise<void>;
  deleteNote(noteId: string): Promise<void>;
  // ... 15+ methods
}
```

**LocalStorage Adapter:**
- Fallback for browser-only mode
- Same API as filesystem adapter
- Default data for new installations

**Filesystem Adapter:**
- Tauri-native file operations
- ID mapping (noteId → file path)
- External change listener support

**usePersistence Hook:**
- Vault selection/creation
- Adapter switching
- Loading/error states

### 3. Phase 2: File Serialization

**NoteSerializer:**
- Standard → pure markdown with YAML frontmatter
- Modular → markdown with `<!-- block:type:id -->` markers
- Visual → markdown stub + `.visual.json` sidecar

**SystemSerializer / ProjectSerializer:**
- `_system.md` and `_project.md` metadata files
- YAML frontmatter with all metadata fields

**Slug Utilities:**
- `generateSlug(title)` → URL-safe filename
- `ensureUniqueSlug(slug, existing)` → append `-1`, `-2` if needed

## Files Created

| File | Purpose |
|------|---------|
| `src-tauri/*` | Tauri configuration and Rust source |
| `src/lib/tauri-bridge.ts` | TypeScript API for Tauri |
| `src/lib/persistence/types.ts` | Interface definitions |
| `src/lib/persistence/localStorage-adapter.ts` | Browser fallback |
| `src/lib/persistence/filesystem-adapter.ts` | Native file access |
| `src/lib/persistence/index.ts` | Entry point |
| `src/lib/serialization/note-serializer.ts` | Markdown serialization |
| `src/lib/attachments/attachment-manager.ts` | Attachment handling |
| `src/lib/attachments/index.ts` | Module exports |
| `src/lib/watcher/file-watcher.ts` | File system watcher |
| `src/lib/watcher/index.ts` | Module exports |
| `src/lib/search/search-index.ts` | MiniSearch wrapper |
| `src/lib/search/index.ts` | Module exports |
| `src/hooks/usePersistence.ts` | Persistence React hook |
| `src/hooks/useAttachments.ts` | Attachment React hook |
| `src/hooks/useFileWatcher.ts` | File watcher React hook |
| `src/hooks/useSearch.ts` | Search React hook |
| `src/components/ExternalChangeNotification.tsx` | Change notifications |
| `src/components/ConflictResolutionDialog.tsx` | Conflict resolution UI |
| `src/components/SearchCommand.tsx` | Command palette search |
| `src/lib/migration/exporter.ts` | Migration logic |
| `src/lib/migration/index.ts` | Module exports |
| `src/components/MigrationWizard.tsx` | Migration wizard UI |
| `src/lib/errors.ts` | Error handling utilities |
| `src/components/VaultProvider.tsx` | Vault initialization |
| `src/components/LoadingStates.tsx` | Skeleton loaders |
| `src/components/StatusBar.tsx` | Status bar |
| `docs/roadmap/local-first-markdown-architecture.md` | Progress tracking |

## Dependencies Added

```json
{
  "@tauri-apps/api": "^2.10.1",
  "@tauri-apps/plugin-fs": "^2.4.5",
  "@tauri-apps/plugin-dialog": "^2.6.0",
  "gray-matter": "^4.0.3",
  "minisearch": "^7.2.0",
  "slugify": "^1.6.6"
}
```

## Vault Structure Design

```
~/Documents/KOL-Noter-Vault/
├── .kol-noter/
│   ├── config.json
│   ├── id-map.json
│   └── search-index.json
├── Work/
│   ├── _system.md
│   └── Engineering/
│       ├── _project.md
│       ├── router-config.md
│       └── assets/
└── Personal/
    └── Learning/
        ├── flowchart.md
        └── flowchart.visual.json
```

## Scripts Added

```json
{
  "tauri": "tauri",
  "tauri:dev": "tauri dev",
  "tauri:build": "tauri build"
}
```

## Prerequisites Setup

User installed:
- Rust (rustc 1.93.0, cargo 1.93.0)
- Sourced `$HOME/.cargo/env` in `~/.zshrc`

### 4. Phase 3: Attachment Handling

**Created AttachmentManager (`src/lib/attachments/attachment-manager.ts`):**
- `saveAttachment(noteId, data, filename)` - saves base64/Blob to file
- `getAttachment(noteId, filename)` - reads file as data URL
- `deleteAttachment(noteId, filename)` - removes attachment file
- `migrateAttachments(noteId, attachments)` - converts base64 to files
- `resolveImagesInContent(content, noteId)` - resolves `![[image]]` syntax

**Updated Tauri Bridge:**
- `writeDataUrlAsFile(path, dataUrl)` - decodes base64 and writes binary
- `readFileAsDataUrl(path, mimeType)` - reads binary and encodes as data URL

**Created useAttachments Hook:**
- Easy-to-use React hook for components
- Handles save, load, delete, and URL resolution

### 5. Phase 4: File Watcher

**Created FileWatcher (`src/lib/watcher/file-watcher.ts`):**
- `startWatching(vaultPath)` - Starts recursive directory watching
- `stopWatching()` - Stops the watcher
- `onFileChange(callback)` - Subscribe to change events
- Debounced event processing (300ms) to handle rapid saves
- Filters out hidden files, config directory, and assets

**Created useFileWatcher Hook:**
- Manages watcher lifecycle with React
- Tracks recent changes for UI display
- Auto-starts when vaultPath is provided

**Created UI Components:**
- `ExternalChangeNotification` - Toast-style notifications for changes
- `ConflictResolutionDialog` - Side-by-side comparison with Keep Local/External/Both

### 6. Phase 5: Search Index

**Created SearchIndex (`src/lib/search/search-index.ts`):**
- MiniSearch-based full-text search
- Indexes notes (all editor types), systems, and projects
- `buildIndex(notes, systems)` - Initial index build
- `updateNote/System/Project()` - Incremental updates
- `search(query, options)` - Fuzzy search with filters
- `suggest(query)` - Autocomplete suggestions
- `saveCache()` / `loadCache()` - Persist to `.kol-noter/search-index.json`

**Created useSearch Hook:**
- Debounced search (150ms default)
- Auto-builds index when data changes
- Caches to filesystem when vault path provided

**Created SearchCommand Component:**
- Command palette UI (Cmd+K / Ctrl+K)
- Groups results by type (notes, systems, projects)
- Shows tags, preview, and relevance score

### 7. Phase 6: Migration Wizard

**Created Exporter (`src/lib/migration/exporter.ts`):**
- `exportToVault(vaultPath, options)` - Main migration function
- `validateLocalStorageData()` - Pre-flight validation
- `hasLocalStorageData()` - Check if migration needed
- `getLocalStorageSize()` / `formatBytes()` - Size utilities
- Progress callbacks for real-time UI updates

**Created MigrationWizard Component:**
- 6-step wizard: intro → validate → select-folder → options → migrating → complete
- Shows item counts (systems, projects, notes, attachments)
- Options: clear localStorage, skip attachments
- Progress bar during migration
- Error recovery with retry option

### 8. Phase 7: Polish & Production

**Created Error Handling (`src/lib/errors.ts`):**
- `AppError` base class with code, recoverable flag
- Specialized errors: `VaultError`, `FileSystemError`, `SerializationError`
- `parseError()` - Converts unknown errors to user-friendly messages
- `withRetry()` - Exponential backoff for flaky operations

**Created VaultProvider (`src/components/VaultProvider.tsx`):**
- Manages app initialization state (loading → setup → ready)
- Setup screen for new users (create/open vault)
- Starts file watcher and search index automatically
- Provides `useVault()` hook for children

**Created Loading States (`src/components/LoadingStates.tsx`):**
- `PageLoader` - Full page spinner
- Skeleton components: NoteCard, NotesList, Sidebar, Editor, DetailPanel
- `EmptyState` / `ErrorState` for edge cases

**Created StatusBar (`src/components/StatusBar.tsx`):**
- Shows current storage mode (Local Vault / Browser Storage)
- Quick access to vault selection and migration

**Updated Production Config:**
- Bundle targets: DMG + App
- File associations: `.md`, `.markdown`
- Drag & drop enabled

## Architecture Complete!

All 8 phases are done. The architecture is ready for integration.

## Next Steps

1. **Integrate into `notesStore.tsx`** - Wire up the persistence adapter
2. **Wrap App with `VaultProvider`** - Enable vault initialization flow
3. **Add `StatusBar` to layout** - Show storage mode
4. **Test end-to-end** - Create vault, add notes, verify files

## Gotchas / Learnings

- `cargo tauri` requires Rust Tauri CLI installed separately
- Use `npx tauri` instead (npm-installed CLI works the same)
- Tauri v2 uses plugin system (`@tauri-apps/plugin-*`)
- `gray-matter` handles YAML frontmatter parsing/stringifying
